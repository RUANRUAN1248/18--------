C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  09/06/23  13:14:11  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE SEEKFREE_IMU963RA
OBJECT MODULE PLACED IN .\Out_File\SEEKFREE_IMU963RA.obj
COMPILER INVOKED BY: D:\Keil_v5\C251\BIN\C251.EXE ..\..\Libraries\seekfree_peripheral\SEEKFREE_IMU963RA.c XSMALL WARNING
                    -LEVEL(3) BROWSE INCDIR(..\..\Libraries\libraries;..\..\Libraries\seekfree_libraries;..\..\Libraries\seekfree_peripheral;
                    -..\CODE;..\USER\inc;..\USER\src;..\..\..\DIANCI) DEBUG PRINT(.\Out_File\SEEKFREE_IMU963RA.lst) TABS(2) OBJECT(.\Out_File
                    -\SEEKFREE_IMU963RA.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2          * MM32F327X-G9P Opensourec Library å³ï¼ˆMM32F327X-G9P å¼€æºåº“ï¼‰æ˜¯ä¸€ä¸ªåŸºäºå®˜æ–¹ SDK æ¥å£çš„ç¬¬
             -ä¸‰æ–¹å¼€æºåº“
    3          * Copyright (c) 2022 SEEKFREE é€é£ç§‘æŠ€
    4          * 
    5          * æœ¬æ–‡ä»¶æ˜¯ MM32F327X-G9P å¼€æºåº“çš„ä¸€éƒ¨åˆ†
    6          * 
    7          * MM32F327X-G9P å¼€æºåº“ æ˜¯å…è´¹è½¯ä»¶
    8          * æ‚¨å¯ä»¥æ ¹æ®è‡ªç”±è½¯ä»¶åŸºé‡‘ä¼šå‘å¸ƒçš„ GPLï¼ˆGNU General Public Licenseï¼Œå³ GNUé€šç”¨å…¬å…±è®¸
             -å¯è¯ï¼‰çš„æ¡æ¬¾
    9          * å³ GPL çš„ç¬¬3ç‰ˆï¼ˆå³ GPL3.0ï¼‰æˆ–ï¼ˆæ‚¨é€‰æ‹©çš„ï¼‰ä»»ä½•åæ¥çš„ç‰ˆæœ¬ï¼Œé‡æ–°å‘å¸ƒå’Œ/æˆ–ä¿®æ”
             -¹å®ƒ
   10          * 
   11          * æœ¬å¼€æºåº“çš„å‘å¸ƒæ˜¯å¸Œæœ›å®ƒèƒ½å‘æŒ¥ä½œç”¨ï¼Œä½†å¹¶æœªå¯¹å…¶ä½œä»»ä½•çš„ä¿è¯
   12          * ç”šè‡³æ²¡æœ‰éšå«çš„é€‚é”€æ€§æˆ–é€‚åˆç‰¹å®šç”¨é€”çš„ä¿è¯
   13          * æ›´å¤šç»†èŠ‚è¯·å‚è§ GPL
   14          * 
   15          * æ‚¨åº”è¯¥åœ¨æ”¶åˆ°æœ¬å¼€æºåº“çš„åŒæ—¶æ”¶åˆ°ä¸€ä»½ GPL çš„å‰¯æœ¬
   16          * å¦‚æœæ²¡æœ‰ï¼Œè¯·å‚é˜…<https://www.gnu.org/licenses/>
   17          * 
   18          * é¢å¤–æ³¨æ˜ï¼š
   19          * æœ¬å¼€æºåº“ä½¿ç”¨ GPL3.0 å¼€æºè®¸å¯è¯åè®® ä»¥ä¸Šè®¸å¯ç”³æ˜ä¸ºè¯‘æ–‡ç‰ˆæœ¬
   20          * è®¸å¯ç”³æ˜è‹±æ–‡ç‰ˆåœ¨ libraries/doc æ–‡ä»¶å¤¹ä¸‹çš„ GPL3_permission_statement.txt æ–‡ä»¶ä¸­
   21          * è®¸å¯è¯å‰¯æœ¬åœ¨ libraries æ–‡ä»¶å¤¹ä¸‹ å³è¯¥æ–‡ä»¶å¤¹ä¸‹çš„ LICENSE æ–‡ä»¶
   22          * æ¬¢è¿å„ä½ä½¿ç”¨å¹¶ä¼ æ’­æœ¬ç¨‹åº ä½†ä¿®æ”¹å†…å®¹æ—¶å¿…é¡»ä¿ç•™é€é£ç§‘æŠ€çš„ç‰ˆæƒå£°æ˜ï¼ˆå³æœ¬
             -å£°æ˜ï¼‰
   23          * 
   24          * æ–‡ä»¶åç§°          zf_device_imu963ra
   25          * å…¬å¸åç§°          æˆéƒ½é€é£ç§‘æŠ€æœ‰é™å…¬å¸
   26          * ç‰ˆæœ¬ä¿¡æ¯          æŸ¥çœ‹ libraries/doc æ–‡ä»¶å¤¹å†… version æ–‡ä»¶ ç‰ˆæœ¬è¯´æ˜
   27          * å¼€å‘ç¯å¢ƒ          IAR 8.32.4 or MDK 5.37
   28          * é€‚ç”¨å¹³å°          MM32F327X_G9P
   29          * åº—é“ºé“¾æ¥          https://seekfree.taobao.com/
   30          * 
   31          * ä¿®æ”¹è®°å½•
   32          * æ—¥æœŸ              ä½œè€…                å¤‡æ³¨
   33          * 2022-08-10        Teternal            first version
   34          *********************************************************************************************************
             -***********/
   35          /********************************************************************************************************
             -*************
   36          * æ¥çº¿å®šä¹‰ï¼š
   37          *                   ------------------------------------
   38          *                   æ¨¡å—ç®¡è„š            å•ç‰‡æœºç®¡è„š
   39          *                   // ç¡¬ä»¶ SPI å¼•è„š
   40          *                   SCL/SPC             æŸ¥çœ‹ zf_device_imu963ra.h ä¸­ IMU963RA_SPC_PIN å®å®šä¹‰
   41          *                   SDA/DSI             æŸ¥çœ‹ zf_device_imu963ra.h ä¸­ IMU963RA_SDI_PIN å®å®šä¹‰
   42          *                   SA0/SDO             æŸ¥çœ‹ zf_device_imu963ra.h ä¸­ IMU963RA_SDO_PIN å®å®šä¹‰
   43          *                   CS                  æŸ¥çœ‹ zf_device_imu963ra.h ä¸­ IMU963RA_CS_PIN  å®å®šä¹‰
   44          *                   VCC                 3.3Vç”µæº
   45          *                   GND                 ç”µæºåœ°
   46          *                   å…¶ä½™å¼•è„šæ‚¬ç©º
   47          *
   48          *                   // è½¯ä»¶ IIC å¼•è„š
   49          *                   SCL/SPC             æŸ¥çœ‹ zf_device_imu963ra.h ä¸­ IMU963RA_SCL_PIN å®å®šä¹‰
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  09/06/23  13:14:11  PAGE 2   

   50          *                   SDA/DSI             æŸ¥çœ‹ zf_device_imu963ra.h ä¸­ IMU963RA_SDA_PIN å®å®šä¹‰
   51          *                   VCC                 3.3Vç”µæº
   52          *                   GND                 ç”µæºåœ°
   53          *                   å…¶ä½™å¼•è„šæ‚¬ç©º
   54          *                   ------------------------------------
   55          *********************************************************************************************************
             -***********/
   56          
   57          #include "SEEKFREE_IMU963RA.h"
   58          
   59          #include "zf_delay.h"
   60          #include "zf_spi.h"
   61          
   62          
   63          
   64          #pragma warning disable = 177
   65          #pragma warning disable = 183
   66          
   67          
   68          int16 imu963ra_gyro_x = 0, imu963ra_gyro_y = 0, imu963ra_gyro_z = 0;
   69          int16 imu963ra_acc_x = 0,  imu963ra_acc_y = 0,  imu963ra_acc_z = 0;
   70          int16 imu963ra_mag_x = 0,  imu963ra_mag_y = 0,  imu963ra_mag_z = 0;
   71          
   72          #if IMU963RA_USE_SOFT_IIC
               
               
               #define GET_IMU963RA_SDA        IMU963RA_SDA_PIN
               #define IMU963RA_SDA_LOW()          IMU963RA_SDA_PIN = 0    //IOå£è¾“å‡ºä½ç”µå¹³
               #define IMU963RA_SDA_HIGH()         IMU963RA_SDA_PIN = 1    //IOå£è¾“å‡ºé«˜ç”µå¹³
               
               #define IMU963RA_SCL_LOW()          IMU963RA_SCL_PIN = 0    //IOå£è¾“å‡ºä½ç”µå¹³
               #define IMU963RA_SCL_HIGH()         IMU963RA_SCL_PIN = 1    //IOå£è¾“å‡ºé«˜ç”µå¹³
               
               #define ack 1      //ä¸»åº”ç­”
               #define no_ack 0   //ä»åº”ç­”  
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      æ¨¡æ‹ŸIICå»¶æ—¶
               //  @return     void            
               //  @since      v1.0
               //  Sample usage:       å¦‚æœIICé€šè®¯å¤±è´¥å¯ä»¥å°è¯•å¢åŠ jçš„å€¼
               //-------------------------------------------------------------------------------------------------------
             -------------
               static void imu963ra_simiic_delay(void)
               {
                   uint16 j=IMU963RA_SOFT_IIC_DELAY;   
                 while(j--);
               }
               
               //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
               static void imu963ra_simiic_start(void)
               {
                 IMU963RA_SDA_HIGH();
                 IMU963RA_SCL_HIGH();
                 imu963ra_simiic_delay();
                 IMU963RA_SDA_LOW();
                 imu963ra_simiic_delay();
                 IMU963RA_SCL_LOW();
               }
               
               //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
               static void imu963ra_simiic_stop(void)
               {
                 IMU963RA_SDA_LOW();
                 IMU963RA_SCL_LOW();
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  09/06/23  13:14:11  PAGE 3   

                 imu963ra_simiic_delay();
                 IMU963RA_SCL_HIGH();
                 imu963ra_simiic_delay();
                 IMU963RA_SDA_HIGH();
                 imu963ra_simiic_delay();
               }
               
               //ä¸»åº”ç­”(åŒ…å«ack:SDA=0å’Œno_ack:SDA=0)
               //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
               static void imu963ra_simiic_sendack(unsigned char ack_dat)
               {
                   IMU963RA_SCL_LOW();
                 imu963ra_simiic_delay();
                 if(ack_dat) IMU963RA_SDA_LOW();
                   else      IMU963RA_SDA_HIGH();
               
                   IMU963RA_SCL_HIGH();
                   imu963ra_simiic_delay();
                   IMU963RA_SCL_LOW();
                   imu963ra_simiic_delay();
               }
               
               
               static int imu963ra_sccb_waitack(void)
               {
                   IMU963RA_SCL_LOW();
               
                 imu963ra_simiic_delay();
                 
                 IMU963RA_SCL_HIGH();
                   imu963ra_simiic_delay();
                 
                   if(GET_IMU963RA_SDA)           //åº”ç­”ä¸ºé«˜ç”µå¹³ï¼Œå¼‚å¸¸ï¼Œé€šä¿¡å¤±è´¥
                   {
               
                       IMU963RA_SCL_LOW();
                       return 0;
                   }
               
                   IMU963RA_SCL_LOW();
                 imu963ra_simiic_delay();
                   return 1;
               }
               
               //å­—èŠ‚å‘é€ç¨‹åº
               //å‘é€c(å¯ä»¥æ˜¯æ•°æ®ä¹Ÿå¯æ˜¯åœ°å€)ï¼Œé€å®Œåæ¥æ”¶ä»åº”ç­”
               //ä¸è€ƒè™‘ä»åº”ç­”ä½
               //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
               static void imu963ra_send_ch(uint8 c)
               {
                 uint8 i = 8;
                   while(i--)
                   {
                       if(c & 0x80)  IMU963RA_SDA_HIGH();//SDA è¾“å‡ºæ•°æ®
                       else      IMU963RA_SDA_LOW();
                       c <<= 1;
                       imu963ra_simiic_delay();
                       IMU963RA_SCL_HIGH();                //SCL æ‹‰é«˜ï¼Œé‡‡é›†ä¿¡å·
                       imu963ra_simiic_delay();
                       IMU963RA_SCL_LOW();                //SCL æ—¶é’Ÿçº¿æ‹‰ä½
                   }
                 imu963ra_sccb_waitack();
               }
               
               
               //å­—èŠ‚æ¥æ”¶ç¨‹åº
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  09/06/23  13:14:11  PAGE 4   

               //æ¥æ”¶å™¨ä»¶ä¼ æ¥çš„æ•°æ®ï¼Œæ­¤ç¨‹åºåº”é…åˆ|ä¸»åº”ç­”å‡½æ•°|ä½¿ç”¨
               //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
               static uint8 imu963ra_read_ch(uint8 ack_x)
               {
                   uint8 i;
                   uint8 c;
                   c=0;
                   IMU963RA_SCL_LOW();
                   imu963ra_simiic_delay();
                   IMU963RA_SDA_HIGH();             
               
                   for(i=0;i<8;i++)
                   {
                       imu963ra_simiic_delay();
                       IMU963RA_SCL_LOW();         //ç½®æ—¶é’Ÿçº¿ä¸ºä½ï¼Œå‡†å¤‡æ¥æ”¶æ•°æ®ä½
                       imu963ra_simiic_delay();
                       IMU963RA_SCL_HIGH();         //ç½®æ—¶é’Ÿçº¿ä¸ºé«˜ï¼Œä½¿æ•°æ®çº¿ä¸Šæ•°æ®æœ‰æ•ˆ
                       imu963ra_simiic_delay();
                       c<<=1;
                       if(GET_IMU963RA_SDA) 
                       {
                           c+=1;   //è¯»æ•°æ®ä½ï¼Œå°†æ¥æ”¶çš„æ•°æ®å­˜c
                       }
                   }
               
                 IMU963RA_SCL_LOW();
                 imu963ra_simiic_delay();
                 imu963ra_simiic_sendack(ack_x);
                 
                   return c;
               }
               
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      æ¨¡æ‹ŸIICå†™æ•°æ®åˆ°è®¾å¤‡å¯„å­˜å™¨å‡½æ•°
               //  @param      dev_add     è®¾å¤‡åœ°å€(ä½ä¸ƒä½åœ°å€)
               //  @param      reg       å¯„å­˜å™¨åœ°å€
               //  @param      dat       å†™å…¥çš„æ•°æ®
               //  @return     void            
               //  @since      v1.0
               //  Sample usage:       
               //-------------------------------------------------------------------------------------------------------
             -------------
               static void imu963ra_simiic_write_reg(uint8 dev_add, uint8 reg, uint8 dat)
               {
                 imu963ra_simiic_start();
                   imu963ra_send_ch( (dev_add<<1) | 0x00);   //å‘é€å™¨ä»¶åœ°å€åŠ å†™ä½
                 imu963ra_send_ch( reg );           //å‘é€ä»æœºå¯„å­˜å™¨åœ°å€
                 imu963ra_send_ch( dat );           //å‘é€éœ€è¦å†™å…¥çš„æ•°æ®
                 imu963ra_simiic_stop();
               }
               
               
               
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      æ¨¡æ‹ŸIICä»è®¾å¤‡å¯„å­˜å™¨è¯»å–æ•°æ®
               //  @param      dev_add     è®¾å¤‡åœ°å€(ä½ä¸ƒä½åœ°å€)
               //  @param      reg       å¯„å­˜å™¨åœ°å€
               //  @param      type      é€‰æ‹©é€šä¿¡æ–¹å¼æ˜¯IIC  è¿˜æ˜¯ SCCB
               //  @return     uint8     è¿”å›å¯„å­˜å™¨çš„æ•°æ®      
               //  @since      v1.0
               //  Sample usage:       
               //-------------------------------------------------------------------------------------------------------
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  09/06/23  13:14:11  PAGE 5   

             -------------
               //static uint8 imu963ra_simiic_read_reg(uint8 dev_add, uint8 reg)
               //{
               //  uint8 dat;
               //  imu963ra_simiic_start();
               //    imu963ra_send_ch( (dev_add<<1) | 0x00);  //å‘é€å™¨ä»¶åœ°å€åŠ å†™ä½
               //  imu963ra_send_ch( reg );          //å‘é€ä»æœºå¯„å­˜å™¨åœ°å€
               
               //  
               //  imu963ra_simiic_start();
               //  imu963ra_send_ch( (dev_add<<1) | 0x01);  //å‘é€å™¨ä»¶åœ°å€åŠ è¯»ä½
               //  dat = imu963ra_read_ch(no_ack);           //è¯»å–æ•°æ®
               //  imu963ra_simiic_stop();
               //  
               //  return dat;
               //}
               
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      æ¨¡æ‹ŸIICä»è®¾å¤‡å¯„å­˜å™¨è¯»å–æ•°æ®
               //  @param      dev_add     è®¾å¤‡åœ°å€(ä½ä¸ƒä½åœ°å€)
               //  @param      reg       å¯„å­˜å™¨åœ°å€
               //  @return     uint8     è¿”å›å¯„å­˜å™¨çš„æ•°æ®      
               //  @since      v1.0
               //  Sample usage:       
               //-------------------------------------------------------------------------------------------------------
             -------------
               static uint8 imu963ra_simiic_sccb_read_reg(uint8 dev_add, uint8 reg)
               {
                 uint8 dat;
                 imu963ra_simiic_start();
                   imu963ra_send_ch( (dev_add<<1) | 0x00);  //å‘é€å™¨ä»¶åœ°å€åŠ å†™ä½
                 imu963ra_send_ch( reg );          //å‘é€ä»æœºå¯„å­˜å™¨åœ°å€
                 imu963ra_simiic_stop();
                 
                 imu963ra_simiic_start();
                 imu963ra_send_ch( (dev_add<<1) | 0x01);  //å‘é€å™¨ä»¶åœ°å€åŠ è¯»ä½
                 dat = imu963ra_read_ch(no_ack);           //è¯»å–æ•°æ®
                 imu963ra_simiic_stop();
                 
                 return dat;
               }
               
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      æ¨¡æ‹ŸIICè¯»å–å¤šå­—èŠ‚æ•°æ®
               //  @param      dev_add     è®¾å¤‡åœ°å€(ä½ä¸ƒä½åœ°å€)
               //  @param      reg       å¯„å­˜å™¨åœ°å€
               //  @param      dat_add     æ•°æ®ä¿å­˜çš„åœ°å€æŒ‡é’ˆ
               //  @param      num       è¯»å–å­—èŠ‚æ•°é‡
               //  @param      type      é€‰æ‹©é€šä¿¡æ–¹å¼æ˜¯IIC  è¿˜æ˜¯ SCCB
               //  @return     uint8     è¿”å›å¯„å­˜å™¨çš„æ•°æ®      
               //  @since      v1.0
               //  Sample usage:       
               //-------------------------------------------------------------------------------------------------------
             -------------
               static void imu963ra_simiic_read_regs(uint8 dev_add, uint8 reg, uint8 *dat_add, uint32 num)
               {
                 imu963ra_simiic_start();
                   imu963ra_send_ch( (dev_add<<1) | 0x00);  //å‘é€å™¨ä»¶åœ°å€åŠ å†™ä½
                 imu963ra_send_ch( reg );          //å‘é€ä»æœºå¯„å­˜å™¨åœ°å€
               
                 
                 imu963ra_simiic_start();
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  09/06/23  13:14:11  PAGE 6   

                 imu963ra_send_ch( (dev_add<<1) | 0x01);  //å‘é€å™¨ä»¶åœ°å€åŠ è¯»ä½
                   while(--num)
                   {
                       *dat_add = imu963ra_read_ch(ack); //è¯»å–æ•°æ®
                       dat_add++;
                   }
                   *dat_add = imu963ra_read_ch(no_ack); //è¯»å–æ•°æ®
                 imu963ra_simiic_stop();
               }
               
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               // å‡½æ•°ç®€ä»‹     IMU963RA å†™å¯„å­˜å™¨
               // å‚æ•°è¯´æ˜     reg             å¯„å­˜å™¨åœ°å€
               // å‚æ•°è¯´æ˜     dat            æ•°æ®
               // è¿”å›å‚æ•°     void
               // ä½¿ç”¨ç¤ºä¾‹     imu963ra_write_acc_gyro_register(IMU963RA_SLV0_CONFIG, 0x00);
               // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
               //-------------------------------------------------------------------------------------------------------
             -------------
               #define imu963ra_write_acc_gyro_register(reg,dat)       (imu963ra_simiic_write_reg(IMU963RA_DEV_ADDR,reg,
             -dat))
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               // å‡½æ•°ç®€ä»‹     IMU963RA è¯»å¯„å­˜å™¨
               // å‚æ•°è¯´æ˜     reg             å¯„å­˜å™¨åœ°å€
               // è¿”å›å‚æ•°     uint8           æ•°æ®
               // ä½¿ç”¨ç¤ºä¾‹     imu963ra_read_acc_gyro_register(IMU963RA_STATUS_MASTER);
               // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
               //-------------------------------------------------------------------------------------------------------
             -------------
               #define imu963ra_read_acc_gyro_register(reg)             (imu963ra_simiic_sccb_read_reg(IMU963RA_DEV_ADDR
             -,reg))
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               // å‡½æ•°ç®€ä»‹     IMU963RA è¯»æ•°æ® å†…éƒ¨è°ƒç”¨
               // å‚æ•°è¯´æ˜     reg             å¯„å­˜å™¨åœ°å€
               // å‚æ•°è¯´æ˜     dat            æ•°æ®ç¼“å†²åŒº
               // å‚æ•°è¯´æ˜     len             æ•°æ®é•¿åº¦
               // è¿”å›å‚æ•°     void
               // ä½¿ç”¨ç¤ºä¾‹     imu963ra_read_acc_gyro_registers(IMU963RA_OUTX_L_A, dat, 6);
               // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
               //-------------------------------------------------------------------------------------------------------
             -------------
               #define imu963ra_read_acc_gyro_registers(reg,dat,len)   (imu963ra_simiic_read_regs(IMU963RA_DEV_ADDR,reg,
             -dat,len))
               
               
               #else
  346          
  347          
  348          
  349          #define IMU963RA_SCK(x)       IMU963RA_SPC_PIN  = x
  350          #define IMU963RA_MOSI(x)      IMU963RA_SDI_PIN = x
  351          #define IMU963RA_CS(x)        IMU963RA_CS_PIN  = x
  352          #define IMU963RA_MISO         IMU963RA_SDO_PIN 
  353          
  354          //-------------------------------------------------------------------------------------------------------
             -------------
  355          //  @brief      é€šè¿‡SPIå†™ä¸€ä¸ªbyte,åŒæ—¶è¯»å–ä¸€ä¸ªbyte
  356          //  @param      byte        å‘é€çš„æ•°æ®    
  357          //  @return     uint8       return è¿”å›statusçŠ¶æ€
  358          //  @since      v1.0
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  09/06/23  13:14:11  PAGE 7   

  359          //  Sample usage:
  360          //-------------------------------------------------------------------------------------------------------
             -------------
  361          static uint8 imu963ra_simspi_wr_byte(uint8 byte)
  362          {
  363   1          uint8 i;
  364   1        
  365   1          for(i=0; i<8; i++)
  366   1          {
  367   2              IMU963RA_MOSI(byte&0x80);
  368   2              byte <<= 1;
  369   2          IMU963RA_SCK (0);
  370   2          IMU963RA_SCK (0);
  371   2          
  372   2          IMU963RA_SCK (1);
  373   2          IMU963RA_SCK (1);
  374   2          byte |= IMU963RA_MISO; 
  375   2          } 
  376   1          return(byte);                                         
  377   1      }
  378          //-------------------------------------------------------------------------------------------------------
             -------------
  379          //  @brief      å°†valå†™å…¥cmdå¯¹åº”çš„å¯„å­˜å™¨åœ°å€,åŒæ—¶è¿”å›statuså­—èŠ‚
  380          //  @param      cmd         å‘½ä»¤å­—
  381          //  @param      val         å¾…å†™å…¥å¯„å­˜å™¨çš„æ•°å€¼
  382          //  @since      v1.0
  383          //  Sample usage:
  384          //-------------------------------------------------------------------------------------------------------
             -------------
  385          static void imu963ra_simspi_w_reg_byte(uint8 cmd, uint8 val)
  386          {
  387   1          IMU963RA_CS(0);
  388   1          cmd |= IMU963RA_SPI_W;
  389   1          imu963ra_simspi_wr_byte(cmd);                       
  390   1          imu963ra_simspi_wr_byte(val);                                 
  391   1          IMU963RA_CS(1);                                     
  392   1      }
  393          
  394          
  395          //-------------------------------------------------------------------------------------------------------
             -------------
  396          //  @brief      å°†valå†™å…¥cmdå¯¹åº”çš„å¯„å­˜å™¨åœ°å€
  397          //  @param      cmd         å‘½ä»¤å­—
  398          //  @param      val         å¾…å†™å…¥å¯„å­˜å™¨çš„æ•°å€¼
  399          //  @since      v1.0
  400          //  Sample usage:
  401          //-------------------------------------------------------------------------------------------------------
             -------------
  402          //static void imu963ra_simspi_w_reg_bytes(uint8 cmd, uint8 *dat_addr, uint32 len)
  403          //{
  404          
  405          //  
  406          //    IMU963RA_CS(0);
  407          //    cmd |= IMU963RA_SPI_W;
  408          //    imu963ra_simspi_wr_byte(cmd);   
  409          //  while(len--)
  410          //  {
  411          //    imu963ra_simspi_wr_byte(*dat_addr++); 
  412          //  }                 
  413          //    IMU963RA_CS(1);                                     
  414          //}
  415          
  416          //-------------------------------------------------------------------------------------------------------
             -------------
  417          //  @brief      è¯»å–cmdæ‰€å¯¹åº”çš„å¯„å­˜å™¨åœ°å€
  418          //  @param      cmd         å‘½ä»¤å­—
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  09/06/23  13:14:11  PAGE 8   

  419          //  @param      *val        å­˜å‚¨è¯»å–çš„æ•°æ®åœ°å€
  420          //  @since      v1.0
  421          //  Sample usage:
  422          //-------------------------------------------------------------------------------------------------------
             -------------
  423          static void imu963ra_simspi_r_reg_byte(uint8 cmd, uint8 *val)
  424          {
  425   1          IMU963RA_CS(0);
  426   1          cmd |= IMU963RA_SPI_R;
  427   1          imu963ra_simspi_wr_byte(cmd);                                 
  428   1          *val = imu963ra_simspi_wr_byte(0);                            
  429   1          IMU963RA_CS(1);                                     
  430   1      }
  431          
  432          //-------------------------------------------------------------------------------------------------------
             -------------
  433          //  @brief      è¯»å–cmdæ‰€å¯¹åº”çš„å¯„å­˜å™¨åœ°å€
  434          //  @param      cmd         å‘½ä»¤å­—
  435          //  @param      *val        å­˜å‚¨è¯»å–çš„æ•°æ®åœ°å€
  436          //  @param      num         è¯»å–çš„æ•°é‡
  437          //  @since      v1.0
  438          //  Sample usage:
  439          //-------------------------------------------------------------------------------------------------------
             -------------
  440          static void imu963ra_simspi_r_reg_bytes(uint8 cmd, uint8 *val, uint32 num)
  441          {
  442   1      
  443   1          cmd |= IMU963RA_SPI_R;
  444   1          imu963ra_simspi_wr_byte(cmd);
  445   1      
  446   1        while(num--)
  447   1        {
  448   2          *val++ = imu963ra_simspi_wr_byte(0);
  449   2        }          
  450   1      }
  451          
  452          
  453          
  454          //-------------------------------------------------------------------------------------------------------
             -------------
  455          // å‡½æ•°ç®€ä»‹     IMU963RA å†™å¯„å­˜å™¨
  456          // å‚æ•°è¯´æ˜     reg             å¯„å­˜å™¨åœ°å€
  457          // å‚æ•°è¯´æ˜     dat            æ•°æ®
  458          // è¿”å›å‚æ•°     void
  459          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_write_acc_gyro_register(IMU963RA_SLV0_CONFIG, 0x00);
  460          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  461          //-------------------------------------------------------------------------------------------------------
             -------------
  462          static void imu963ra_write_acc_gyro_register(uint8 reg, uint8 dat)
  463          {
  464   1          IMU963RA_CS(0);
  465   1          imu963ra_simspi_w_reg_byte(reg | IMU963RA_SPI_W, dat);
  466   1      
  467   1          IMU963RA_CS(1);
  468   1      }
  469          
  470          //-------------------------------------------------------------------------------------------------------
             -------------
  471          // å‡½æ•°ç®€ä»‹     IMU963RA è¯»å¯„å­˜å™¨
  472          // å‚æ•°è¯´æ˜     reg             å¯„å­˜å™¨åœ°å€
  473          // è¿”å›å‚æ•°     uint8           æ•°æ®
  474          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_read_acc_gyro_register(IMU963RA_STATUS_MASTER);
  475          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  476          //-------------------------------------------------------------------------------------------------------
             -------------
  477          static uint8 imu963ra_read_acc_gyro_register(uint8 reg)
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  09/06/23  13:14:11  PAGE 9   

  478          {
  479   1          uint8 dat = 0;
  480   1          IMU963RA_CS(0);
  481   1        imu963ra_simspi_r_reg_byte(reg | IMU963RA_SPI_R , &dat);
  482   1          IMU963RA_CS(1);
  483   1          return dat;
  484   1      }
  485          
  486          //-------------------------------------------------------------------------------------------------------
             -------------
  487          // å‡½æ•°ç®€ä»‹     IMU963RA è¯»æ•°æ® å†…éƒ¨è°ƒç”¨
  488          // å‚æ•°è¯´æ˜     reg             å¯„å­˜å™¨åœ°å€
  489          // å‚æ•°è¯´æ˜     dat            æ•°æ®ç¼“å†²åŒº
  490          // å‚æ•°è¯´æ˜     len             æ•°æ®é•¿åº¦
  491          // è¿”å›å‚æ•°     void
  492          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_read_acc_gyro_registers(IMU963RA_OUTX_L_A, dat, 6);
  493          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  494          //-------------------------------------------------------------------------------------------------------
             -------------
  495          static void imu963ra_read_acc_gyro_registers(uint8 reg, uint8 *dat, uint32 len)
  496          {
  497   1          IMU963RA_CS(0);
  498   1          imu963ra_simspi_r_reg_bytes( reg | IMU963RA_SPI_R, dat, len);
  499   1      
  500   1          IMU963RA_CS(1);
  501   1      }
  502          #endif
  503          
  504          //-------------------------------------------------------------------------------------------------------
             -------------
  505          // å‡½æ•°ç®€ä»‹     IMU963RA ä½œä¸º IIC ä¸»æœºå‘ç£åŠ›è®¡å†™æ•°æ®
  506          // å‚æ•°è¯´æ˜     addr            ç›®æ ‡åœ°å€
  507          // å‚æ•°è¯´æ˜     reg             ç›®æ ‡å¯„å­˜å™¨
  508          // å‚æ•°è¯´æ˜     dat            æ•°æ®
  509          // è¿”å›å‚æ•°     uint8           1-å¤±è´¥ 0-æˆåŠŸ
  510          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_write_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_CONTROL2, 0x80);
  511          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  512          //-------------------------------------------------------------------------------------------------------
             -------------
  513          static uint8 imu963ra_write_mag_register (uint8 addr, uint8 reg, uint8 dat)
  514          {
  515   1          uint8 return_state = 0;
  516   1          uint16 timeout_count = 0;
  517   1      
  518   1          addr = addr << 1;
  519   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_CONFIG, 0x00);               // ä»æœº0é…ç½®æ¸…é™¤
  520   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_ADD, addr | 0);              // è®¾ç½®åœ°ç£è®¡åœ°å€ï
             -¼ˆæ³¨æ„è¿™é‡Œéœ€è¦è®¾ç½®8ä½çš„I2Cåœ°å€ï¼‰ 0x2C
  521   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_SUBADD, reg);                // éœ€è¦å†™å…¥çš„å¯„å­˜å
             -™¨åœ°å€
  522   1          imu963ra_write_acc_gyro_register(IMU963RA_DATAWRITE_SLV0, dat);            // éœ€è¦å†™å…¥çš„æ•°æ®
  523   1          imu963ra_write_acc_gyro_register(IMU963RA_MASTER_CONFIG, 0x4C);             // ä»…åœ¨ç¬¬ä¸€ä¸ªå‘¨æœŸå
             -¯ç”¨é€šè®¯ å¼€å¯ä¸Šæ‹‰ I2Cä¸»æœºä½¿èƒ½
  524   1          
  525   1          // ç­‰å¾…é€šè®¯æˆåŠŸ
  526   1          while(0 == (0x80 & imu963ra_read_acc_gyro_register(IMU963RA_STATUS_MASTER)))
  527   1          {
  528   2              if(timeout_count ++ > IMU963RA_TIMEOUT_COUNT)
  529   2              {
  530   3                  return_state = 1;
  531   3                  break;
  532   3              }
  533   2              delay_ms(2);
  534   2          }
  535   1          return return_state;
  536   1      }
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  09/06/23  13:14:11  PAGE 10  

  537          
  538          //-------------------------------------------------------------------------------------------------------
             -------------
  539          // å‡½æ•°ç®€ä»‹     IMU963RA ä½œä¸º IIC ä¸»æœºå‘ç£åŠ›è®¡è¯»æ•°æ®
  540          // å‚æ•°è¯´æ˜     addr            ç›®æ ‡åœ°å€
  541          // å‚æ•°è¯´æ˜     reg             ç›®æ ‡å¯„å­˜å™¨
  542          // è¿”å›å‚æ•°     uint8           è¯»å–çš„æ•°æ®
  543          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_read_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_CHIP_ID);
  544          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  545          //-------------------------------------------------------------------------------------------------------
             -------------
  546          static uint8 imu963ra_read_mag_register (uint8 addr, uint8 reg)
  547          {
  548   1          uint16 timeout_count = 0;
  549   1      
  550   1          addr = addr << 1;
  551   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_ADD, addr | 1);              // è®¾ç½®åœ°ç£è®¡åœ°å€ï
             -¼ˆæ³¨æ„è¿™é‡Œéœ€è¦è®¾ç½®8ä½çš„I2Cåœ°å€ï¼‰ 0x2C
  552   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_SUBADD, reg);                // éœ€è¦è¯»å–çš„å¯„å­˜å
             -™¨åœ°å€
  553   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_CONFIG, 0x01);    
  554   1          imu963ra_write_acc_gyro_register(IMU963RA_MASTER_CONFIG, 0x4C);             // ä»…åœ¨ç¬¬ä¸€ä¸ªå‘¨æœŸå
             -¯ç”¨é€šè®¯ å¼€å¯ä¸Šæ‹‰ I2Cä¸»æœºä½¿èƒ½
  555   1          
  556   1          // ç­‰å¾…é€šè®¯æˆåŠŸ
  557   1          while(0 == (0x01 & imu963ra_read_acc_gyro_register(IMU963RA_STATUS_MASTER)))
  558   1          {
  559   2              if(timeout_count ++ > IMU963RA_TIMEOUT_COUNT)
  560   2              {
  561   3                  break;
  562   3              }
  563   2              delay_ms(2);
  564   2          }
  565   1          
  566   1          return (imu963ra_read_acc_gyro_register(IMU963RA_SENSOR_HUB_1));            // è¿”å›è¯»å–åˆ°çš„æ•°æ
             -®
  567   1      }
  568          
  569          //-------------------------------------------------------------------------------------------------------
             -------------
  570          // å‡½æ•°ç®€ä»‹     IMU963RA ä½œä¸º IIC ä¸»æœºå‘ç£åŠ›è®¡è‡ªåŠ¨å†™æ•°æ®
  571          // å‚æ•°è¯´æ˜     addr            ç›®æ ‡åœ°å€
  572          // å‚æ•°è¯´æ˜     reg             ç›®æ ‡å¯„å­˜å™¨
  573          // è¿”å›å‚æ•°     void
  574          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_connect_mag(IMU963RA_MAG_ADDR, IMU963RA_MAG_OUTX_L);
  575          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  576          //-------------------------------------------------------------------------------------------------------
             -------------
  577          static void imu963ra_connect_mag (uint8 addr, uint8 reg)
  578          {
  579   1          addr = addr << 1;
  580   1          
  581   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_ADD, addr | 1);              // è®¾ç½®åœ°ç£è®¡åœ°å€ï
             -¼ˆæ³¨æ„è¿™é‡Œéœ€è¦è®¾ç½®8ä½çš„I2Cåœ°å€ï¼‰ 0x2C
  582   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_SUBADD, reg);                // éœ€è¦è¯»å–çš„å¯„å­˜å
             -™¨åœ°å€
  583   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_CONFIG, 0x06);    
  584   1          imu963ra_write_acc_gyro_register(IMU963RA_MASTER_CONFIG, 0x6C);             // ä»…åœ¨ç¬¬ä¸€ä¸ªå‘¨æœŸå
             -¯ç”¨é€šè®¯ å¼€å¯ä¸Šæ‹‰ I2Cä¸»æœºä½¿èƒ½
  585   1      }   
  586          
  587          
  588          //-------------------------------------------------------------------------------------------------------
             -------------
  589          // å‡½æ•°ç®€ä»‹     IMU963RA å…­è½´è‡ªæ£€ å†…éƒ¨è°ƒç”¨
  590          // å‚æ•°è¯´æ˜     void
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  09/06/23  13:14:11  PAGE 11  

  591          // è¿”å›å‚æ•°     uint8           1-è‡ªæ£€å¤±è´¥ 0-è‡ªæ£€æˆåŠŸ
  592          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_acc_gyro_self_check();
  593          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  594          //-------------------------------------------------------------------------------------------------------
             -------------
  595          static uint8 imu963ra_acc_gyro_self_check (void)
  596          {
  597   1          uint8 return_state = 0;
  598   1          uint8 dat = 0;
  599   1          uint16 timeout_count = 0;
  600   1      
  601   1          while(0x6B != dat)                                                          // åˆ¤æ–­ ID æ˜¯å¦æ­£ç¡®
  602   1          {
  603   2              if(timeout_count++ > IMU963RA_TIMEOUT_COUNT)
  604   2              {
  605   3                  return_state = 1;
  606   3                  break;
  607   3              }
  608   2              dat = imu963ra_read_acc_gyro_register(IMU963RA_WHO_AM_I);
  609   2              delay_ms(10);
  610   2          }
  611   1          return return_state;
  612   1      }
  613          
  614          //-------------------------------------------------------------------------------------------------------
             -------------
  615          // å‡½æ•°ç®€ä»‹     IMU963RA ç£åŠ›è®¡è‡ªæ£€ å†…éƒ¨è°ƒç”¨
  616          // å‚æ•°è¯´æ˜     void
  617          // è¿”å›å‚æ•°     uint8           1-è‡ªæ£€å¤±è´¥ 0-è‡ªæ£€æˆåŠŸ
  618          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_mag_self_check();
  619          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  620          //-------------------------------------------------------------------------------------------------------
             -------------
  621          static uint8 imu963ra_mag_self_check (void)
  622          {
  623   1          uint8 return_state = 0;
  624   1          uint8 dat = 0;
  625   1          uint16 timeout_count = 0;
  626   1      
  627   1          while(0xff != dat)                                                          // åˆ¤æ–­ ID æ˜¯å¦æ­£ç¡®
  628   1          {
  629   2              if(timeout_count++ > IMU963RA_TIMEOUT_COUNT)
  630   2              {
  631   3                  return_state = 1;
  632   3                  break;
  633   3              }
  634   2              dat = imu963ra_read_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_CHIP_ID);
  635   2              delay_ms(10);
  636   2          }
  637   1          return return_state;
  638   1      }
  639          
  640          //-------------------------------------------------------------------------------------------------------
             -------------
  641          // å‡½æ•°ç®€ä»‹     è·å– IMU963RA åŠ é€Ÿåº¦è®¡æ•°æ®
  642          // å‚æ•°è¯´æ˜     void
  643          // è¿”å›å‚æ•°     void
  644          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_get_acc();
  645          // å¤‡æ³¨ä¿¡æ¯     æ‰§è¡Œè¯¥å‡½æ•°åï¼Œç›´æ¥æŸ¥çœ‹å¯¹åº”çš„å˜é‡å³å¯
  646          //-------------------------------------------------------------------------------------------------------
             -------------
  647          void imu963ra_get_acc (void)
  648          {
  649   1          uint8 dat[6];
  650   1      
  651   1          imu963ra_read_acc_gyro_registers(IMU963RA_OUTX_L_A, dat, 6);
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  09/06/23  13:14:11  PAGE 12  

  652   1          imu963ra_acc_x = (int16)(((uint16)dat[1]<<8 | dat[0]));
  653   1          imu963ra_acc_y = (int16)(((uint16)dat[3]<<8 | dat[2]));
  654   1          imu963ra_acc_z = (int16)(((uint16)dat[5]<<8 | dat[4]));
  655   1      }
  656          
  657          
  658          //-------------------------------------------------------------------------------------------------------
             -------------
  659          // å‡½æ•°ç®€ä»‹     è·å–IMU963RAé™€èºä»ªæ•°æ®
  660          // å‚æ•°è¯´æ˜     void
  661          // è¿”å›å‚æ•°     void
  662          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_get_gyro();
  663          // å¤‡æ³¨ä¿¡æ¯     æ‰§è¡Œè¯¥å‡½æ•°åï¼Œç›´æ¥æŸ¥çœ‹å¯¹åº”çš„å˜é‡å³å¯
  664          //-------------------------------------------------------------------------------------------------------
             -------------
  665          void imu963ra_get_gyro (void)
  666          {
  667   1          uint8 dat[6];
  668   1      
  669   1          imu963ra_read_acc_gyro_registers(IMU963RA_OUTX_L_G, dat, 6);
  670   1          imu963ra_gyro_x = (int16)(((uint16)dat[1]<<8 | dat[0]));
  671   1          imu963ra_gyro_y = (int16)(((uint16)dat[3]<<8 | dat[2]));
  672   1          imu963ra_gyro_z = (int16)(((uint16)dat[5]<<8 | dat[4]));
  673   1      }
  674          
  675          
  676          //-------------------------------------------------------------------------------------------------------
             -------------
  677          // å‡½æ•°ç®€ä»‹     è·å– IMU963RA ç£åŠ›è®¡æ•°æ®
  678          // å‚æ•°è¯´æ˜     void
  679          // è¿”å›å‚æ•°     void
  680          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_get_mag();
  681          // å¤‡æ³¨ä¿¡æ¯     æ‰§è¡Œè¯¥å‡½æ•°åï¼Œç›´æ¥æŸ¥çœ‹å¯¹åº”çš„å˜é‡å³å¯
  682          //-------------------------------------------------------------------------------------------------------
             -------------
  683          void imu963ra_get_mag (void)
  684          {
  685   1          uint8 temp_status;
  686   1          uint8 dat[6];
  687   1      
  688   1          imu963ra_write_acc_gyro_register(IMU963RA_FUNC_CFG_ACCESS, 0x40);
  689   1          temp_status = imu963ra_read_acc_gyro_register(IMU963RA_STATUS_MASTER);
  690   1          if(0x01 & temp_status)
  691   1          {
  692   2              imu963ra_read_acc_gyro_registers(IMU963RA_SENSOR_HUB_1, dat, 6);
  693   2              imu963ra_mag_x = (int16)(((uint16)dat[1]<<8 | dat[0]));
  694   2              imu963ra_mag_y = (int16)(((uint16)dat[3]<<8 | dat[2]));
  695   2              imu963ra_mag_z = (int16)(((uint16)dat[5]<<8 | dat[4]));
  696   2          }
  697   1          imu963ra_write_acc_gyro_register(IMU963RA_FUNC_CFG_ACCESS, 0x00);
  698   1      }
  699          
  700          //-------------------------------------------------------------------------------------------------------
             -------------
  701          // å‡½æ•°ç®€ä»‹     å°† IMU963RA åŠ é€Ÿåº¦è®¡æ•°æ®è½¬æ¢ä¸ºå®é™…ç‰©ç†æ•°æ®
  702          // å‚æ•°è¯´æ˜     gyro_value      ä»»æ„è½´çš„åŠ é€Ÿåº¦è®¡æ•°æ®
  703          // è¿”å›å‚æ•°     void
  704          // ä½¿ç”¨ç¤ºä¾‹     float dat = imu963ra_acc_transition(imu963ra_acc_x);           // å•ä½ä¸º g(m/s^2)
  705          // å¤‡æ³¨ä¿¡æ¯
  706          //-------------------------------------------------------------------------------------------------------
             -------------
  707          float imu963ra_acc_transition (int16 acc_value)
  708          {
  709   1          float acc_dat = 0;
  710   1          switch(IMU963RA_ACC_SAMPLE)
  711   1          {
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  09/06/23  13:14:11  PAGE 13  

  712   2              case 0x30: acc_dat = (float)acc_value / 16393; break;                  // 0x30 åŠ é€Ÿåº¦é‡ç¨‹ä¸º
             -:Â±2G      è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥ 16393 ï¼Œå¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  713   2              case 0x38: acc_dat = (float)acc_value / 8197;  break;                  // 0x38 åŠ é€Ÿåº¦é‡ç¨‹ä¸º
             -:Â±4G      è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥ 8197 ï¼Œ å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  714   2              case 0x3C: acc_dat = (float)acc_value / 4098;  break;                  // 0x3C åŠ é€Ÿåº¦é‡ç¨‹ä¸º
             -:Â±8G      è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥ 4098 ï¼Œ å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  715   2              case 0x34: acc_dat = (float)acc_value / 2049;  break;                  // 0x34 åŠ é€Ÿåº¦é‡ç¨‹ä¸º
             -:Â±16G     è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥ 2049 ï¼Œ å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  716   2              default: break;
  717   2          }
  718   1          return acc_dat;
  719   1      }
  720          
  721          //-------------------------------------------------------------------------------------------------------
             -------------
  722          // å‡½æ•°ç®€ä»‹     å°† IMU963RA é™€èºä»ªæ•°æ®è½¬æ¢ä¸ºå®é™…ç‰©ç†æ•°æ®
  723          // å‚æ•°è¯´æ˜     gyro_value      ä»»æ„è½´çš„é™€èºä»ªæ•°æ®
  724          // è¿”å›å‚æ•°     void
  725          // ä½¿ç”¨ç¤ºä¾‹     float dat = imu963ra_gyro_transition(imu963ra_gyro_x);         // å•ä½ä¸ºÂ°/s
  726          // å¤‡æ³¨ä¿¡æ¯
  727          //-------------------------------------------------------------------------------------------------------
             -------------
  728          float imu963ra_gyro_transition (int16 gyro_value)
  729          {
  730   1          float gyro_dat = 0;
  731   1          switch(IMU963RA_GYR_SAMPLE)
  732   1          {
  733   2              case 0x52: gyro_dat = (float)gyro_value / 228.6f;  break;              //  0x52 é™€èºä»ªé‡ç¨‹ä¸
             -º:Â±125dps  è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥ 228.6ï¼Œ   å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  734   2              case 0x50: gyro_dat = (float)gyro_value / 114.3f;  break;              //  0x50 é™€èºä»ªé‡ç¨‹ä¸
             -º:Â±250dps  è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥ 114.3ï¼Œ   å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  735   2              case 0x54: gyro_dat = (float)gyro_value / 57.1f;   break;              //  0x54 é™€èºä»ªé‡ç¨‹ä¸
             -º:Â±500dps  è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥ 57.1ï¼Œ    å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  736   2              case 0x58: gyro_dat = (float)gyro_value / 28.6f;   break;              //  0x58 é™€èºä»ªé‡ç¨‹ä¸
             -º:Â±1000dps è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥ 28.6ï¼Œ    å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  737   2              case 0x5C: gyro_dat = (float)gyro_value / 14.3f;   break;              //  0x5C é™€èºä»ªé‡ç¨‹ä¸
             -º:Â±2000dps è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥ 14.3ï¼Œ    å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  738   2              case 0x51: gyro_dat = (float)gyro_value / 7.1f;    break;              //  0x51 é™€èºä»ªé‡ç¨‹ä¸
             -º:Â±4000dps è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥ 7.1ï¼Œ     å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  739   2              default: break;
  740   2          }
  741   1          return gyro_dat;
  742   1      }
  743          
  744          //-------------------------------------------------------------------------------------------------------
             -------------
  745          // å‡½æ•°ç®€ä»‹     å°† IMU963RA åœ°ç£è®¡æ•°æ®è½¬æ¢ä¸ºå®é™…ç‰©ç†æ•°æ®
  746          // å‚æ•°è¯´æ˜     mag_value       ä»»æ„è½´çš„åœ°ç£è®¡æ•°æ®
  747          // è¿”å›å‚æ•°     void
  748          // ä½¿ç”¨ç¤ºä¾‹     float dat = imu963ra_mag_transition(imu963ra_mag_x);          // å•ä½ä¸ºG(é«˜æ–¯)
  749          // å¤‡æ³¨ä¿¡æ¯
  750          //-------------------------------------------------------------------------------------------------------
             -------------
  751          float imu963ra_mag_transition (int16 mag_value)
  752          {
  753   1          float mag_dat = 0;
  754   1          switch(IMU963RA_MAG_SAMPLE)
  755   1          {
  756   2              case 0x19: mag_dat = (float)mag_value / 3000;  break;                  //  0x19 ç£åŠ›è®¡é‡ç¨‹ä¸
             -º:8G     è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥3000ï¼Œ å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šG(é«˜æ–¯)
  757   2              case 0x09: mag_dat = (float)mag_value / 12000; break;                  //  0x09 ç£åŠ›è®¡é‡ç¨‹ä¸
             -º:2G     è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥12000ï¼Œå¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šG(é«˜æ–¯)
  758   2              default: break;
  759   2          }
  760   1          return mag_dat;
  761   1      }
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  09/06/23  13:14:11  PAGE 14  

  762          
  763          //-------------------------------------------------------------------------------------------------------
             -------------
  764          // å‡½æ•°ç®€ä»‹     åˆå§‹åŒ– IMU963RA
  765          // å‚æ•°è¯´æ˜     void
  766          // è¿”å›å‚æ•°     uint8           1-åˆå§‹åŒ–å¤±è´¥ 0-åˆå§‹åŒ–æˆåŠŸ
  767          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_init();
  768          // å¤‡æ³¨ä¿¡æ¯     
  769          //-------------------------------------------------------------------------------------------------------
             -------------
  770          uint8 imu963ra_init (void)
  771          {
  772   1          uint8 return_state = 0;
  773   1          delay_ms(10);                                                        // ä¸Šç”µå»¶æ—¶
  774   1      
  775   1      //#if IMU963RA_USE_SOFT_IIC
  776   1      //    soft_iic_init(&imu963ra_iic_struct, IMU963RA_DEV_ADDR, IMU963RA_SOFT_IIC_DELAY, IMU963RA_SCL_PIN, I
             -MU963RA_SDA_PIN);
  777   1      //#else
  778   1      //    spi_init(IMU963RA_SPI, SPI_MODE0, IMU963RA_SPI_SPEED, IMU963RA_SPC_PIN, IMU963RA_SDI_PIN, IMU963RA_
             -SDO_PIN, SPI_CS_NULL);
  779   1      //    gpio_init(IMU963RA_CS_PIN, GPO, GPIO_LOW, GPO_PUSH_PULL);
  780   1      //#endif
  781   1      
  782   1          do
  783   1          {
  784   2              imu963ra_write_acc_gyro_register(IMU963RA_FUNC_CFG_ACCESS, 0x00);       // å…³é—­HUBå¯„å­˜å™¨è®¿é
             -—®
  785   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL3_C, 0x01);               // å¤ä½è®¾å¤‡
  786   2              delay_ms(2);                             
  787   2              imu963ra_write_acc_gyro_register(IMU963RA_FUNC_CFG_ACCESS, 0x00);       // å…³é—­HUBå¯„å­˜å™¨è®¿é
             -—®
  788   2              if(imu963ra_acc_gyro_self_check())                   
  789   2              {                
  790   3      //      while(1)
  791   3      //      {
  792   3              printf( "IMU963RA acc and gyro self check error.\r\n");                    
  793   3      //        delay_ms(200);
  794   3      //      };
  795   3            
  796   3                  
  797   3                  return_state = 1;
  798   3                  break;            
  799   3              }                   
  800   2                                  
  801   2              imu963ra_write_acc_gyro_register(IMU963RA_INT1_CTRL, 0x03);             // å¼€å¯é™€èºä»ª åŠ é€Ÿ
             -åº¦æ•°æ®å°±ç»ªä¸­æ–­
  802   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL1_XL, IMU963RA_GYR_SAMPLE);   // è®¾ç½®åŠ é€Ÿåº¦è®¡
             -é‡ç¨‹ Â±8G ä»¥åŠæ•°æ®è¾“å‡ºé€Ÿç‡ 52hz ä»¥åŠåŠ é€Ÿåº¦ä¿¡æ¯ä»ç¬¬ä¸€çº§æ»¤æ³¢å™¨è¾“å‡º
  803   2              // IMU963RA_CTRL1_XL å¯„å­˜å™¨
  804   2              // è®¾ç½®ä¸º:0x30 åŠ é€Ÿåº¦é‡ç¨‹ä¸º:Â±2G      è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥16393ï¼Œå¯ä»
             -¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  805   2              // è®¾ç½®ä¸º:0x38 åŠ é€Ÿåº¦é‡ç¨‹ä¸º:Â±4G      è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥8197ï¼Œ å¯ä»
             -¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  806   2              // è®¾ç½®ä¸º:0x3C åŠ é€Ÿåº¦é‡ç¨‹ä¸º:Â±8G      è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥4098ï¼Œ å¯ä»
             -¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  807   2              // è®¾ç½®ä¸º:0x34 åŠ é€Ÿåº¦é‡ç¨‹ä¸º:Â±16G     è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥2049ï¼Œ å¯ä»
             -¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  808   2              
  809   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL2_G, IMU963RA_ACC_SAMPLE);    // è®¾ç½®é™€èºä»ªè®¡
             -é‡ç¨‹ Â±2000dps ä»¥åŠæ•°æ®è¾“å‡ºé€Ÿç‡ 208hz
  810   2              // IMU963RA_CTRL2_G å¯„å­˜å™¨
  811   2              // è®¾ç½®ä¸º:0x52 é™€èºä»ªé‡ç¨‹ä¸º:Â±125dps  è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥228.6ï¼Œ   å¯ä»¥
             -è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  812   2              // è®¾ç½®ä¸º:0x50 é™€èºä»ªé‡ç¨‹ä¸º:Â±250dps  è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥114.3ï¼Œ   å¯ä»¥
             -è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  09/06/23  13:14:11  PAGE 15  

  813   2              // è®¾ç½®ä¸º:0x54 é™€èºä»ªé‡ç¨‹ä¸º:Â±500dps  è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥57.1ï¼Œ    å¯ä»¥
             -è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  814   2              // è®¾ç½®ä¸º:0x58 é™€èºä»ªé‡ç¨‹ä¸º:Â±1000dps è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥28.6ï¼Œ    å¯ä»¥
             -è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  815   2              // è®¾ç½®ä¸º:0x5C é™€èºä»ªé‡ç¨‹ä¸º:Â±2000dps è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥14.3ï¼Œ    å¯ä»¥
             -è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  816   2              // è®¾ç½®ä¸º:0x51 é™€èºä»ªé‡ç¨‹ä¸º:Â±4000dps è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥7.1ï¼Œ     å¯ä»¥
             -è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  817   2              
  818   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL3_C, 0x44);               // ä½¿èƒ½é™€èºä»ªæ•°å­—ä
             -½é€šæ»¤æ³¢å™¨
  819   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL4_C, 0x02);               // ä½¿èƒ½æ•°å­—ä½é€šæ»¤æ
             -³¢å™¨
  820   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL5_C, 0x00);               // åŠ é€Ÿåº¦è®¡ä¸é™€èºä
             -»ªå››èˆäº”å…¥
  821   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL6_C, 0x00);               // å¼€å¯åŠ é€Ÿåº¦è®¡é«˜æ
             -€§èƒ½æ¨¡å¼ é™€èºä»ªä½é€šæ»¤æ³¢ 133hz
  822   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL7_G, 0x00);               // å¼€å¯é™€èºä»ªé«˜æ€§è
             -ƒ½æ¨¡å¼ å…³é—­é«˜é€šæ»¤æ³¢
  823   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL9_XL, 0x01);              // å…³é—­I3Cæ¥å£
  824   2      
  825   2              imu963ra_write_acc_gyro_register(IMU963RA_FUNC_CFG_ACCESS, 0x40);       // å¼€å¯HUBå¯„å­˜å™¨è®¿é
             -—® ç”¨äºé…ç½®åœ°ç£è®¡
  826   2              imu963ra_write_acc_gyro_register(IMU963RA_MASTER_CONFIG, 0x80);         // å¤ä½I2Cä¸»æœº
  827   2              delay_ms(2);                             
  828   2              imu963ra_write_acc_gyro_register(IMU963RA_MASTER_CONFIG, 0x00);         // æ¸…é™¤å¤ä½æ ‡å¿—
  829   2              delay_ms(2);
  830   2              
  831   2              imu963ra_write_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_CONTROL2, 0x80);// å¤ä½è¿æ¥çš„å¤–
             -è®¾
  832   2              delay_ms(2);
  833   2              imu963ra_write_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_CONTROL2, 0x00);
  834   2              delay_ms(2);
  835   2              
  836   2              
  837   2              if(imu963ra_mag_self_check())
  838   2              {
  839   3      //      while(1)
  840   3      //      {
  841   3              printf("IMU963RA mag self check error.\r\n");
  842   3      //        delay_ms(200);
  843   3      //      };
  844   3            
  845   3                  
  846   3                  return_state = 1;
  847   3                  break;            
  848   3              }
  849   2      
  850   2              imu963ra_write_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_CONTROL1, IMU963RA_MAG_SAMPLE); // è®
             -¾ç½®ç£åŠ›è®¡é‡ç¨‹8G è¾“å‡ºé€Ÿç‡100hz è¿ç»­æ¨¡å¼
  851   2              // IMU963RA_MAG_ADDR å¯„å­˜å™¨
  852   2              // è®¾ç½®ä¸º:0x19 ç£åŠ›è®¡é‡ç¨‹ä¸º:8G     è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥3000ï¼Œ å¯ä»¥è½
             -¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šG(é«˜æ–¯)
  853   2              // è®¾ç½®ä¸º:0x09 ç£åŠ›è®¡é‡ç¨‹ä¸º:2G     è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥12000ï¼Œå¯ä»¥è½
             -¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šG(é«˜æ–¯)
  854   2              
  855   2              imu963ra_write_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_FBR, 0x01);
  856   2              imu963ra_connect_mag(IMU963RA_MAG_ADDR, IMU963RA_MAG_OUTX_L);
  857   2              
  858   2              imu963ra_write_acc_gyro_register(IMU963RA_FUNC_CFG_ACCESS, 0x00);       // å…³é—­HUBå¯„å­˜å™¨è®¿é
             -—®
  859   2      
  860   2              delay_ms(20);                                                    // ç­‰å¾…ç£åŠ›è®¡è·å–æ•°æ®
  861   2          }while(0);
  862   1          return return_state;
  863   1      }
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  09/06/23  13:14:11  PAGE 16  



Module Information          Static   Overlayable
------------------------------------------------
  code size            =      1001     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =        18         25
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       129     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
